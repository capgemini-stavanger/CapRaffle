@model CapRaffle.Models.EventViewModel

@{
    ViewBag.Title = "Details";
}

    <script type="text/javascript">
        $(document).ready(function () {

            $(".participants form").submit(function (e) {
                $.post($(this).attr("action"),
                    $(this).serialize(),
                    function (data) {
                        $(".ParticipantsTable").html(data);
                    });
                e.preventDefault();
            });

            $("form#adminAddParticipant").submit(function (e) {
                $.post($(this).attr("action"),
                    $(this).serialize(),
                    function (data) {
                        $(".ParticipantsTable").html(data);
                    });
                e.preventDefault();
            });

            $("#removeparticipation").click(function (e) {
                @if (Model.UserIsParticipant) {
                    <text>
                    var postdata = { UserEmail: '@Model.LoggedInParticipant.UserEmail', NumberOfSpots: '@Model.LoggedInParticipant.NumberOfSpots', EventId: '@Model.LoggedInParticipant.EventId' };
                    </text>
                }
                
                $.ajax({
                    url: '@Url.Action("Delete", "Participant")',
                    type: 'POST',
                    data: postdata,
                    success: function (data) {
                        location.reload();
                    }
                });
            });

        
            $("#adminUserEmailTextbox").autocomplete({
                source: function (request, response) {
                    $.ajax({    
                        type: 'POST',
                        url: '@Url.Action("GetUsers", "Participant")',
                        data: { email: request.term },
                        dataType: "json",
                        success: function(data) {
                            response(data)
                        },
                        error: function(data) {
                            alert(data)
                        }
                    });
                },
                minLength: 2
            });
            $('button#DrawWinner').click(function () {
                var view = $("#view option:selected").val();
                $.ajax({
                    type: 'post',
                    url: '@Url.Action("DrawWinner", "DrawWinner")',
                    data: 'eventId=@Model.SelectedEvent.EventId&view='+view,
                    success: function(data){ 
                        $('.drawWinner').html(data)
                    }
                })
            });
        });
    </script>
    <div class="right">
        <div class="participants">
        <h2>Participants</h2>
            <div class="ParticipantsTable">
                @Html.Action("GetParticipants", "Participant", new { eventId = Model.SelectedEvent.EventId })
            </div>
            @if (@HttpContext.Current.User.Identity.IsAuthenticated)
            {
                using (Html.BeginForm("Create", "Participant", FormMethod.Post, new { id = "addParticipant" }))
                {
                    @Html.AntiForgeryToken()   
                    <input type="hidden" name="UserEmail" value="@HttpContext.Current.User.Identity.Name" />
                    <input type="hidden" name="EventId" value="@Model.SelectedEvent.EventId" />
            
                    <label for="NumberOfSpots">@(Model.UserIsParticipant ? "Update" : "Choose") number of spots</label>
                    @Html.DropDownList("NumberOfSpots", Model.NumberOfSpots)    
                <!--<input type="text" name="NumberOfSpots" />-->
                        <div class="buttons">
                            <button type="submit" class="positive" name="register">
                            <img src="@Url.Content("~/Content/images/apply2.png")" alt=""/>
                                @(Model.UserIsParticipant ? "Update" : "Register")
                            </button>
                        </div>
                if (!Model.UserIsParticipant) { <br /> }
                }
                if (Model.UserIsParticipant)
                {
                    <div class="buttons">
                        <button class="nagative" type="submit" id="removeparticipation">
                            <img src="@Url.Content("~/Content/images/cross.png")" alt=""/>
                            Delete participation
                        </button>
                    </div>
                <br />
                }
            }
            else
            {
                <p>Sign in if you want to register for this event:</p>
            }
        </div>
        <br />
        <br />
        <div class="eventadministration">
            @if (@HttpContext.Current.User.Identity.Name.Equals(Model.SelectedEvent.Creator))
            {   
                <h2>Event administration</h2>
                using (Html.BeginForm("Delete", "Event"))
                {
                    @Html.AntiForgeryToken()
                    @Html.Hidden("id", Model.SelectedEvent.EventId)
        
                    <div class="buttons">
                        <button type="submit" class="nagative" name="DeleteEvent">
                            <img src="@Url.Content("~/Content/images/cross.png")" alt=""/>
                            Delete event
                        </button>
                    </div>
                }
                
                <div class="buttons">
                    <button type="submit" class="positive" name="edit" id="edit" onclick="javascript:window.location=('@Url.Action("Edit", "Event", new { id = @Model.SelectedEvent.EventId })')">
                        <img src="@Url.Content("~/Content/images/textfield_key.png")" alt=""/>
                        Edit event
                    </button>
                </div>
                <br /><br /><br />
                <h4>Register User for this event</h4>
                             using (Html.BeginForm("Create", "Participant", FormMethod.Post, new { id = "adminAddParticipant" }))
                   {
                    @Html.AntiForgeryToken()
                    <input id="adminUserEmailTextbox" type="text" name="UserEmail" />
                    <input type="hidden" name="EventId" value="@Model.SelectedEvent.EventId" />
                    @Html.DropDownList("NumberOfSpots", Model.NumberOfSpots) 
                    <div class="buttons">
                        <button type="submit" class="positive" name="register" id="adminAddParticipant">
                            <img src="@Url.Content("~/Content/images/plus.gif")" alt=""/>
                            Add
                        </button>
                    </div>
                }
                <br />
                <br />
                <h4> Draw winner for this event</h4>
                @Html.DropDownList("view", Model.RaffleTypes)
                <div class="buttons">
                    <button id="DrawWinner" class="positive" name="DrawWinner">
                        <img src="@Url.Content("~/Content/images/apply2.png")" alt=""/>
                        Draw winners
                    </button>
                    </div>
                <br />
            }
        </div>
    </div>
    <div class="event">
        <h3 class="eventheader">@Model.SelectedEvent.Name</h3>
        <h6 style="">Created by: @Model.SelectedEvent.Creator on @Model.SelectedEvent.Created.ToString("dd MMM yyyy") under @Model.SelectedEvent.Category.Name</h6>
        <p>@Model.SelectedEvent.Description</p>
        <p>@(Model.SelectedEvent.InformationUrl == null ? "" : "More information about the event: " + @Model.SelectedEvent.InformationUrl)</p>
        <h4>Number of available spots: @Model.SelectedEvent.AvailableSpots</h4>
        <h4>Deadline: @Model.SelectedEvent.DeadLine</h4>
    </div>

    <br />
    <div class="bottom">
        <div class="drawWinner">
            
        </div>
   </div>
   

